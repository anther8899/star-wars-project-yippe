<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SWU Collection â€” For Sale</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    /* === Custom Properties === */
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #1a1a2e;
      --bg-card: #16213e;
      --bg-input: #0f3460;
      --bg-hover: #1f2b4d;
      --text-primary: #e0e0e0;
      --text-secondary: #a0a0a0;
      --text-muted: #666;
      --accent-gold: #f5c518;
      --accent-blue: #4fc3f7;
      --accent-red: #e53935;
      --accent-green: #66bb6a;
      --border-color: #2a2a4a;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 4px 20px rgba(0, 0, 0, 0.7);
      --radius: 8px;
      --radius-sm: 4px;
      --font-main: 'Segoe UI', system-ui, -apple-system, sans-serif;
      --rarity-common: #b0b0b0;
      --rarity-uncommon: #66bb6a;
      --rarity-rare: #4fc3f7;
      --rarity-legendary: #f5c518;
      --rarity-special: #ce93d8;
    }

    /* === Reset & Base === */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 16px; -webkit-text-size-adjust: 100%; }
    body {
      font-family: var(--font-main);
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-primary); }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #3a3a5a; }

    /* === Header === */
    #app-header {
      background: var(--bg-secondary);
      border-bottom: 2px solid var(--accent-gold);
      padding: 16px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
    }

    .app-title {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .title-accent { color: var(--accent-gold); }

    #collection-stats {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .stat-divider { color: var(--text-muted); }
    #total-cards { color: var(--text-primary); }
    #unique-cards { color: var(--text-secondary); }
    #total-value { color: var(--accent-green); }
    #filtered-count { color: var(--accent-blue); font-size: 0.85rem; }

    /* === Controls === */
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    #controls input[type="text"],
    #controls select {
      font-family: var(--font-main);
      background: var(--bg-input);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 8px 12px;
      font-size: 0.85rem;
      outline: none;
      transition: border-color 0.2s;
    }

    #controls input[type="text"]:focus,
    #controls select:focus {
      border-color: var(--accent-blue);
    }

    #search { flex: 1; min-width: 180px; }
    #controls select { cursor: pointer; min-width: 110px; }

    #view-toggle {
      display: flex;
      gap: 0;
      border-radius: var(--radius-sm);
      overflow: hidden;
      border: 1px solid var(--border-color);
      margin-left: auto;
    }

    .view-btn {
      padding: 7px 12px;
      background: var(--bg-card);
      color: var(--text-secondary);
      border: none;
      border-radius: 0;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      font-family: var(--font-main);
      transition: background 0.15s;
    }

    .view-btn.active {
      background: var(--accent-gold);
      color: #111;
    }

    .view-btn:hover:not(.active) {
      background: var(--bg-hover);
    }

    /* === Main === */
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    /* === Loading & Error === */
    #loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    #loading[hidden] { display: none; }

    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent-gold);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    #error {
      text-align: center;
      padding: 40px 20px;
      background: rgba(229, 57, 53, 0.1);
      border: 1px solid var(--accent-red);
      border-radius: var(--radius);
      color: var(--accent-red);
      margin-top: 16px;
    }

    /* === Grid View === */
    #grid-view {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .card-tile {
      position: relative;
      background: var(--bg-card);
      border-radius: var(--radius);
      overflow: hidden;
      transition: transform 0.15s, box-shadow 0.2s;
      border-left: 3px solid var(--rarity-common);
    }

    .card-tile:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .card-tile.rarity-common { border-left-color: var(--rarity-common); }
    .card-tile.rarity-uncommon { border-left-color: var(--rarity-uncommon); }
    .card-tile.rarity-rare { border-left-color: var(--rarity-rare); }
    .card-tile.rarity-legendary { border-left-color: var(--rarity-legendary); }
    .card-tile.rarity-special { border-left-color: var(--rarity-special); }

    .card-tile-image {
      width: 100%;
      aspect-ratio: 63/88;
      object-fit: cover;
      display: block;
    }

    .card-placeholder {
      width: 100%;
      aspect-ratio: 63/88;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 0.75rem;
      text-align: center;
      padding: 8px;
    }

    .card-tile-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.85));
      padding: 30px 8px 8px;
    }

    .card-tile-name {
      font-size: 0.8rem;
      font-weight: 600;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-tile-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .card-tile-price { color: var(--accent-green); }

    .card-tile-qty {
      position: absolute;
      top: 6px;
      right: 6px;
      background: rgba(0, 0, 0, 0.75);
      color: var(--accent-gold);
      font-size: 0.75rem;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 22px;
      text-align: center;
    }

    .card-tile-variant {
      position: absolute;
      top: 6px;
      left: 6px;
      background: rgba(206, 147, 216, 0.85);
      color: #111;
      font-size: 0.65rem;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* === Table View === */
    #table-view { margin-top: 16px; overflow-x: auto; }

    #collection-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    #collection-table thead th {
      background: var(--bg-secondary);
      color: var(--text-secondary);
      text-transform: uppercase;
      font-size: 0.72rem;
      letter-spacing: 0.5px;
      padding: 10px 8px;
      text-align: left;
      position: sticky;
      top: 0;
      white-space: nowrap;
      cursor: pointer;
      border-bottom: 2px solid var(--border-color);
    }

    #collection-table thead th:hover { color: var(--accent-gold); }

    #collection-table tbody tr {
      border-bottom: 1px solid var(--border-color);
      transition: background 0.15s;
    }

    #collection-table tbody tr:nth-child(even) {
      background: rgba(22, 33, 62, 0.3);
    }

    #collection-table tbody tr:hover { background: var(--bg-hover); }

    #collection-table td {
      padding: 6px 8px;
      vertical-align: middle;
    }

    .table-card-img {
      width: 40px;
      height: 56px;
      object-fit: cover;
      border-radius: 3px;
    }

    .table-rarity {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 4px;
      vertical-align: middle;
    }

    /* === Empty State === */
    #empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
      font-size: 1rem;
    }

    /* === Footer === */
    footer {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
      font-size: 0.75rem;
      border-top: 1px solid var(--border-color);
      margin-top: 40px;
    }

    /* === Card Add Button === */
    .card-tile-add {
      position: absolute;
      top: 6px;
      right: 6px;
      background: rgba(102, 187, 106, 0.9);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.15s, transform 0.15s;
      z-index: 5;
    }
    .card-tile:hover .card-tile-add { opacity: 1; }
    .card-tile-add:hover { transform: scale(1.15); background: var(--accent-green); }
    .card-tile-add.added {
      background: var(--accent-gold);
      opacity: 1;
    }

    /* === Buyer Cart Panel === */
    #buyer-cart-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 200;
      background: var(--accent-green);
      color: #111;
      border: none;
      border-radius: 50px;
      padding: 12px 20px;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.15s, background 0.15s;
      font-family: var(--font-main);
    }
    #buyer-cart-toggle:hover { transform: scale(1.05); }
    #buyer-cart-toggle .cart-badge {
      background: var(--accent-red);
      color: #fff;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
    }
    #buyer-cart-toggle[hidden] { display: none; }

    #buyer-cart-panel {
      position: fixed;
      top: 0;
      right: -420px;
      width: 400px;
      max-width: 90vw;
      height: 100vh;
      background: var(--bg-secondary);
      border-left: 2px solid var(--accent-gold);
      z-index: 300;
      display: flex;
      flex-direction: column;
      transition: right 0.3s ease;
      box-shadow: -4px 0 20px rgba(0,0,0,0.5);
    }
    #buyer-cart-panel.open { right: 0; }

    #buyer-cart-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 250;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    #buyer-cart-overlay.open { opacity: 1; pointer-events: auto; }

    .cart-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
    }
    .cart-panel-header h2 { font-size: 1.1rem; }
    .cart-panel-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.4rem;
      cursor: pointer;
      padding: 4px 8px;
      font-family: var(--font-main);
    }
    .cart-panel-close:hover { color: var(--accent-red); }

    .cart-panel-body {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    .cart-panel-empty {
      text-align: center;
      color: var(--text-muted);
      padding: 40px 16px;
      font-size: 0.9rem;
    }

    .cart-item {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-color);
    }
    .cart-item-img {
      width: 45px;
      height: 63px;
      object-fit: cover;
      border-radius: 3px;
      flex-shrink: 0;
    }
    .cart-item-info { flex: 1; min-width: 0; }
    .cart-item-name {
      font-weight: 600;
      font-size: 0.85rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .cart-item-meta { font-size: 0.75rem; color: var(--text-secondary); }
    .cart-item-price { font-size: 0.85rem; color: var(--accent-green); font-weight: 600; }

    .cart-item-qty {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .cart-item-qty button {
      background: var(--bg-input);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      width: 26px;
      height: 26px;
      cursor: pointer;
      font-size: 0.9rem;
      font-family: var(--font-main);
    }
    .cart-item-qty button:hover { background: var(--bg-hover); }
    .cart-item-qty span { font-weight: 600; min-width: 18px; text-align: center; }

    .cart-item-remove {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 1rem;
      padding: 4px;
      font-family: var(--font-main);
    }
    .cart-item-remove:hover { color: var(--accent-red); }

    .cart-panel-footer {
      padding: 16px;
      border-top: 1px solid var(--border-color);
    }
    .cart-total-row {
      display: flex;
      justify-content: space-between;
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 12px;
    }
    .cart-total-row .total-price { color: var(--accent-green); }

    .cart-panel-footer .cart-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .btn-copy-wishlist {
      background: var(--accent-gold);
      color: #111;
      border: none;
      border-radius: var(--radius-sm);
      padding: 12px;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      font-family: var(--font-main);
      transition: background 0.15s;
    }
    .btn-copy-wishlist:hover { background: #e6b800; }

    .btn-clear-wishlist {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 8px;
      font-size: 0.8rem;
      cursor: pointer;
      font-family: var(--font-main);
    }
    .btn-clear-wishlist:hover { color: var(--accent-red); border-color: var(--accent-red); }

    .cart-copied-msg {
      text-align: center;
      color: var(--accent-green);
      font-size: 0.85rem;
      font-weight: 600;
      padding: 8px 0;
      display: none;
    }

    .buyer-name-input {
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 8px;
      background: var(--bg-input);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      font-family: var(--font-main);
      outline: none;
    }
    .buyer-name-input:focus { border-color: var(--accent-blue); }

    /* === Responsive === */
    @media (max-width: 600px) {
      .app-title { font-size: 1.1rem; }
      .header-top { flex-direction: column; align-items: flex-start; }
      #controls { flex-direction: column; align-items: stretch; }
      #search { min-width: 100%; }
      #controls select { min-width: 100%; }
      #view-toggle { margin-left: 0; align-self: stretch; }
      .view-btn { flex: 1; text-align: center; }
      #grid-view { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px; }
      /* Always show add button on mobile (no hover) */
      .card-tile-add { opacity: 0.85; width: 32px; height: 32px; font-size: 1.2rem; }
      /* Cart panel full-width on mobile */
      #buyer-cart-panel { width: 100%; max-width: 100vw; right: -100%; }
      #buyer-cart-toggle { bottom: 12px; right: 12px; padding: 10px 16px; font-size: 0.85rem; }
      /* Bigger touch targets in cart */
      .cart-item-qty button { width: 34px; height: 34px; font-size: 1.1rem; }
      .cart-item-remove { font-size: 1.2rem; padding: 8px; }
      .btn-copy-wishlist { padding: 14px; font-size: 1rem; }
    }

    /* Touch device support â€” always show add button */
    @media (hover: none) {
      .card-tile-add { opacity: 0.85; }
    }

    @media (min-width: 768px) {
      #grid-view { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
    }

    @media (min-width: 1024px) {
      #grid-view { grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); }
    }
  </style>
</head>
<body>
  <header id="app-header">
    <div class="header-top">
      <h1 class="app-title">SWU <span class="title-accent">Collection</span></h1>
      <div id="collection-stats">
        <span id="total-cards">0 cards</span>
        <span class="stat-divider">|</span>
        <span id="unique-cards">0 unique</span>
        <span class="stat-divider">|</span>
        <span id="total-value">$0.00</span>
        <span id="filtered-count"></span>
      </div>
    </div>
    <div id="controls">
      <input id="search" type="text" placeholder="Search cards...">
      <select id="filter-rarity">
        <option value="">All Rarities</option>
        <option value="Common">Common</option>
        <option value="Uncommon">Uncommon</option>
        <option value="Rare">Rare</option>
        <option value="Legendary">Legendary</option>
        <option value="Special">Special</option>
      </select>
      <select id="filter-set">
        <option value="">All Sets</option>
      </select>
      <select id="filter-aspect">
        <option value="">All Aspects</option>
      </select>
      <select id="filter-type">
        <option value="">All Types</option>
      </select>
      <select id="sort-by">
        <option value="name-asc">Name A-Z</option>
        <option value="name-desc">Name Z-A</option>
        <option value="price-desc">Price High-Low</option>
        <option value="price-asc">Price Low-High</option>
        <option value="set-asc">Set</option>
        <option value="rarity-desc">Rarity (Legendary First)</option>
      </select>
      <div id="view-toggle">
        <button id="view-grid" class="view-btn active">Grid</button>
        <button id="view-list" class="view-btn">Table</button>
      </div>
    </div>
  </header>

  <main>
    <div id="loading">
      <div class="spinner"></div>
      <p>Loading collection...</p>
    </div>

    <div id="error" hidden>
      <p id="error-text"></p>
    </div>

    <div id="empty-state" hidden>
      <p>No cards match your filters.</p>
    </div>

    <div id="grid-view"></div>

    <div id="table-view" hidden>
      <table id="collection-table">
        <thead>
          <tr>
            <th></th>
            <th data-sort="name">Name</th>
            <th data-sort="set">Set</th>
            <th data-sort="number">#</th>
            <th data-sort="rarity">Rarity</th>
            <th data-sort="type">Type</th>
            <th>Aspects</th>
            <th>Variant</th>
            <th data-sort="quantity">Qty</th>
            <th data-sort="marketPrice">Price $</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
  </main>

  <!-- Buyer Cart Toggle Button -->
  <button id="buyer-cart-toggle" hidden>
    ðŸ›’ My List <span class="cart-badge" id="buyer-cart-badge">0</span>
  </button>

  <!-- Cart Overlay -->
  <div id="buyer-cart-overlay"></div>

  <!-- Cart Slide Panel -->
  <div id="buyer-cart-panel">
    <div class="cart-panel-header">
      <h2>My Wishlist</h2>
      <button class="cart-panel-close" id="buyer-cart-close">&times;</button>
    </div>
    <div class="cart-panel-body" id="buyer-cart-body">
      <div class="cart-panel-empty">Click the + button on cards to add them here.</div>
    </div>
    <div class="cart-panel-footer">
      <input type="text" class="buyer-name-input" id="buyer-name" placeholder="Your name (optional)">
      <div class="cart-total-row">
        <span>Total:</span>
        <span class="total-price" id="buyer-cart-total">$0.00</span>
      </div>
      <div class="cart-actions">
        <button class="btn-copy-wishlist" id="btn-copy-wishlist">ðŸ“‹ Copy Wishlist to Send</button>
        <div class="cart-copied-msg" id="cart-copied-msg">Copied! Send this to the seller.</div>
        <button class="btn-clear-wishlist" id="btn-clear-wishlist">Clear All</button>
      </div>
    </div>
  </div>

  <footer>
    <p>Prices updated on each sync. Contact seller to purchase.</p>
  </footer>

  <script>
    const PV = {
      // ========== CONFIG ==========
      // Change this to your Google Sheet ID
      SHEET_ID: '1obPzdu07q19l3psMZaCSSCIWGf07Kun8OVM7I2TFQaA',

      // ========== STATE ==========
      allCards: [],
      filteredCards: [],
      viewMode: 'grid',
      buyerCart: [],  // Array of { card, quantity }

      // ========== INIT ==========
      async init() {
        this.setupEventListeners();
        this.setupCartListeners();

        // Allow overriding sheet ID from URL param
        const params = new URLSearchParams(window.location.search);
        if (params.get('sheet')) this.SHEET_ID = params.get('sheet');

        try {
          const csvText = await this.fetchData();
          this.allCards = this.parseCSV(csvText);
          this.populateFilterDropdowns(this.allCards);
          this.applyFilters();
          document.getElementById('loading').hidden = true;
        } catch (err) {
          document.getElementById('loading').hidden = true;
          document.getElementById('error').hidden = false;
          document.getElementById('error-text').textContent =
            'Failed to load collection: ' + err.message +
            ' â€” Make sure the Google Sheet is shared as "Anyone with the link."';
        }
      },

      // ========== DATA FETCHING ==========
      async fetchData() {
        const urls = [
          `https://docs.google.com/spreadsheets/d/${this.SHEET_ID}/gviz/tq?tqx=out:csv`,
          `https://docs.google.com/spreadsheets/d/${this.SHEET_ID}/pub?output=csv`,
        ];

        let csvText = null;
        for (const url of urls) {
          try {
            const resp = await fetch(url);
            if (resp.ok) {
              csvText = await resp.text();
              if (csvText && csvText.trim().length > 0) break;
            }
          } catch (e) { continue; }
        }

        if (!csvText || csvText.trim().length === 0) {
          throw new Error('Could not fetch spreadsheet data.');
        }
        return csvText;
      },

      // ========== CSV PARSING ==========
      parseCSV(csvText) {
        const result = Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          transformHeader: h => h.trim(),
        });

        // Find the Front Art column â€” may be named 'Front Art' or have a blank header
        // containing image URLs (https://cdn.swu-db.com/...)
        const artCol = this.findArtColumn(result.fields || result.meta.fields, result.data);

        return result.data.map(row => ({
          name:            row['Name'] || '',
          subtitle:        row['Subtitle'] || '',
          set:             row['Set'] || '',
          number:          row['Number'] || '',
          rarity:          row['Rarity'] || '',
          type:            row['Type'] || '',
          aspects:         row['Aspects'] || '',
          variantType:     row['Variant Type'] || 'Normal',
          quantity:        parseInt(row['Quantity']) || 1,
          marketPrice:     this.parsePrice(row['Market Price']),
          discountedPrice: this.parsePrice(row['Discounted Price']),
          notes:           row['Notes'] || '',
          frontArt:        artCol ? (row[artCol] || '') : (row['Front Art'] || ''),
        })).filter(card => card.name.trim() !== '');
      },

      findArtColumn(fields, data) {
        if (!fields) return null;
        // If 'Front Art' header exists, use it
        if (fields.includes('Front Art')) return 'Front Art';
        // Otherwise, scan unnamed/blank columns for image URLs
        const sample = data.slice(0, 5);
        for (const f of fields) {
          if (['Name','Subtitle','Set','Number','Rarity','Type','Aspects',
               'Variant Type','Quantity','Market Price','Discounted Price','Notes'].includes(f)) continue;
          const hasUrl = sample.some(row => (row[f] || '').match(/^https?:\/\/.+\.(png|jpg|jpeg|webp)/i));
          if (hasUrl) return f;
        }
        return null;
      },

      parsePrice(str) {
        if (!str) return 0;
        return parseFloat(String(str).replace(/[$,]/g, '')) || 0;
      },

      // ========== FILTERS & SORT ==========
      applyFilters() {
        const search = document.getElementById('search').value.trim().toLowerCase();
        const rarity = document.getElementById('filter-rarity').value;
        const set    = document.getElementById('filter-set').value;
        const aspect = document.getElementById('filter-aspect').value;
        const type   = document.getElementById('filter-type').value;

        let cards = this.allCards;

        if (search) {
          cards = cards.filter(c =>
            c.name.toLowerCase().includes(search) ||
            c.subtitle.toLowerCase().includes(search) ||
            c.set.toLowerCase().includes(search) ||
            c.type.toLowerCase().includes(search) ||
            c.aspects.toLowerCase().includes(search) ||
            (c.variantType && c.variantType.toLowerCase().includes(search))
          );
        }

        if (rarity) cards = cards.filter(c => c.rarity === rarity);
        if (set)    cards = cards.filter(c => c.set === set);
        if (type)   cards = cards.filter(c => c.type === type);
        if (aspect) cards = cards.filter(c => c.aspects.includes(aspect));

        cards = this.sortCards(cards);
        this.filteredCards = cards;
        this.render();
        this.updateStats();
      },

      sortCards(cards) {
        const sortVal = document.getElementById('sort-by').value;
        const [key, dir] = sortVal.split('-');
        const mult = dir === 'asc' ? 1 : -1;

        return [...cards].sort((a, b) => {
          switch (key) {
            case 'name':
              return a.name.localeCompare(b.name) * mult;
            case 'price':
              return (a.marketPrice - b.marketPrice) * mult;
            case 'set':
              return (a.set + String(a.number).padStart(4, '0')).localeCompare(b.set + String(b.number).padStart(4, '0')) * mult;
            case 'rarity':
              return (this.rarityRank(a.rarity) - this.rarityRank(b.rarity)) * mult;
            case 'quantity':
              return (a.quantity - b.quantity) * mult;
            case 'marketPrice':
              return (a.marketPrice - b.marketPrice) * mult;
            case 'discountedPrice':
              return ((a.discountedPrice || a.marketPrice) - (b.discountedPrice || b.marketPrice)) * mult;
            case 'number':
              return (parseInt(a.number) - parseInt(b.number)) * mult;
            case 'type':
              return a.type.localeCompare(b.type) * mult;
            default:
              return 0;
          }
        });
      },

      rarityRank(rarity) {
        const r = (rarity || '').toLowerCase();
        if (r.includes('common') && !r.includes('un')) return 1;
        if (r.includes('uncommon')) return 2;
        if (r.includes('rare') && !r.includes('legendary')) return 3;
        if (r.includes('legendary')) return 4;
        if (r.includes('special')) return 5;
        return 0;
      },

      // ========== RENDERING ==========
      render() {
        const gridEl = document.getElementById('grid-view');
        const tableEl = document.getElementById('table-view');
        const emptyEl = document.getElementById('empty-state');

        if (this.filteredCards.length === 0) {
          gridEl.innerHTML = '';
          document.getElementById('table-body').innerHTML = '';
          emptyEl.hidden = false;
          gridEl.style.display = 'none';
          tableEl.hidden = true;
          return;
        }

        emptyEl.hidden = true;

        if (this.viewMode === 'grid') {
          gridEl.style.display = 'grid';
          tableEl.hidden = true;
          this.renderGrid(this.filteredCards);
        } else {
          gridEl.style.display = 'none';
          tableEl.hidden = false;
          this.renderTable(this.filteredCards);
        }
      },

      renderGrid(cards) {
        const grid = document.getElementById('grid-view');
        grid.innerHTML = '';

        for (const card of cards) {
          const tile = document.createElement('div');
          const rarityClass = this.getRarityClass(card.rarity);
          tile.className = `card-tile ${rarityClass}`;

          const variantLabel = card.variantType && card.variantType !== 'Normal' ? card.variantType : '';

          let imageHTML;
          if (card.frontArt) {
            imageHTML = `<img class="card-tile-image" src="${this.esc(card.frontArt)}" alt="${this.esc(card.name)}" loading="lazy" onerror="this.outerHTML='<div class=\\'card-placeholder\\'>${this.esc(card.name)}</div>'">`;
          } else {
            imageHTML = `<div class="card-placeholder">${this.esc(card.name)}</div>`;
          }

          const inCart = this.buyerCart.find(i => this._cardKey(i.card) === this._cardKey(card));
          const addedClass = inCart ? ' added' : '';

          tile.innerHTML = `
            ${imageHTML}
            <button class="card-tile-add${addedClass}" title="Add to wishlist">${inCart ? 'âœ“' : '+'}</button>
            ${card.quantity > 1 ? `<div class="card-tile-qty">x${card.quantity}</div>` : ''}
            ${variantLabel ? `<div class="card-tile-variant">${this.esc(variantLabel)}</div>` : ''}
            <div class="card-tile-info">
              <div class="card-tile-name">${this.esc(card.name)}${card.subtitle ? ' â€” ' + this.esc(card.subtitle) : ''}</div>
              <div class="card-tile-meta">
                <span>${this.esc(card.set)} #${card.number}</span>
                <span class="card-tile-price">$${card.marketPrice.toFixed(2)}</span>
              </div>
            </div>
          `;

          const addBtn = tile.querySelector('.card-tile-add');
          addBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.addToBuyerCart(card);
            addBtn.textContent = 'âœ“';
            addBtn.classList.add('added');
          });

          grid.appendChild(tile);
        }
      },

      renderTable(cards) {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';

        for (const card of cards) {
          const rarityColor = this.getRarityColor(card.rarity);
          const variantLabel = card.variantType && card.variantType !== 'Normal' ? card.variantType : '';

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${card.frontArt
              ? `<img class="table-card-img" src="${this.esc(card.frontArt)}" alt="" loading="lazy" onerror="this.style.display='none'">`
              : ''
            }</td>
            <td>
              <strong>${this.esc(card.name)}</strong>
              ${card.subtitle ? `<br><small style="color:var(--text-secondary)">${this.esc(card.subtitle)}</small>` : ''}
              ${variantLabel ? `<br><small style="color:var(--rarity-special)">${this.esc(variantLabel)}</small>` : ''}
            </td>
            <td>${this.esc(card.set)}</td>
            <td>${card.number}</td>
            <td><span class="table-rarity" style="background:${rarityColor}"></span>${this.esc(card.rarity)}</td>
            <td>${this.esc(card.type)}</td>
            <td>${this.esc(card.aspects)}</td>
            <td>${this.esc(variantLabel || 'Normal')}</td>
            <td>${card.quantity}</td>
            <td style="color:var(--accent-green);font-weight:600">$${card.marketPrice.toFixed(2)}</td>
          `;
          tbody.appendChild(tr);
        }
      },

      // ========== STATS ==========
      updateStats() {
        const all = this.allCards;
        const filtered = this.filteredCards;
        const totalQty = all.reduce((sum, c) => sum + c.quantity, 0);
        const uniqueCount = all.length;
        const totalValue = all.reduce((sum, c) => sum + (c.marketPrice * c.quantity), 0);

        document.getElementById('total-cards').textContent = `${totalQty} cards`;
        document.getElementById('unique-cards').textContent = `${uniqueCount} unique`;
        document.getElementById('total-value').textContent = `$${totalValue.toFixed(2)}`;

        const filteredEl = document.getElementById('filtered-count');
        if (filtered.length < all.length) {
          filteredEl.textContent = `(showing ${filtered.length})`;
        } else {
          filteredEl.textContent = '';
        }
      },

      // ========== DYNAMIC FILTERS ==========
      populateFilterDropdowns(cards) {
        const sets = [...new Set(cards.map(c => c.set).filter(Boolean))].sort();
        const types = [...new Set(cards.map(c => c.type).filter(Boolean))].sort();
        const aspects = [...new Set(
          cards.flatMap(c => c.aspects.split(/\s*\/\s*/).filter(Boolean))
        )].sort();

        this.populateSelect('filter-set', sets);
        this.populateSelect('filter-type', types);
        this.populateSelect('filter-aspect', aspects);
      },

      populateSelect(id, values) {
        const select = document.getElementById(id);
        while (select.options.length > 1) select.remove(1);
        for (const val of values) {
          const opt = document.createElement('option');
          opt.value = val;
          opt.textContent = val;
          select.appendChild(opt);
        }
      },

      // ========== EVENT LISTENERS ==========
      setupEventListeners() {
        // Search with debounce
        let debounce = null;
        document.getElementById('search').addEventListener('input', () => {
          clearTimeout(debounce);
          debounce = setTimeout(() => this.applyFilters(), 200);
        });

        // Filter dropdowns + sort
        ['filter-rarity', 'filter-set', 'filter-type', 'filter-aspect', 'sort-by'].forEach(id => {
          document.getElementById(id).addEventListener('change', () => this.applyFilters());
        });

        // View toggle
        document.getElementById('view-grid').addEventListener('click', () => {
          this.viewMode = 'grid';
          document.getElementById('view-grid').classList.add('active');
          document.getElementById('view-list').classList.remove('active');
          this.render();
        });

        document.getElementById('view-list').addEventListener('click', () => {
          this.viewMode = 'table';
          document.getElementById('view-list').classList.add('active');
          document.getElementById('view-grid').classList.remove('active');
          this.render();
        });

        // Sortable table headers
        document.querySelectorAll('#collection-table th[data-sort]').forEach(th => {
          th.addEventListener('click', () => {
            const key = th.dataset.sort;
            const sortSelect = document.getElementById('sort-by');
            const current = sortSelect.value;
            const [currentKey, currentDir] = current.split('-');

            // Toggle direction if clicking same column, otherwise asc
            const newDir = (currentKey === key && currentDir === 'asc') ? 'desc' : 'asc';

            // Check if this sort option exists in the select
            const optionVal = `${key}-${newDir}`;
            const exists = [...sortSelect.options].some(o => o.value === optionVal);
            if (exists) {
              sortSelect.value = optionVal;
            } else {
              // For columns like quantity, number, etc. â€” just re-sort with custom logic
              sortSelect.value = `${key}-${newDir}`;
              // Add temporary option if needed
              if (!exists) {
                const opt = document.createElement('option');
                opt.value = optionVal;
                opt.textContent = key + ' ' + newDir;
                sortSelect.appendChild(opt);
                sortSelect.value = optionVal;
              }
            }
            this.applyFilters();
          });
        });
      },

      // ========== UTILITIES ==========
      esc(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      },

      getRarityClass(rarity) {
        const r = (rarity || '').toLowerCase();
        if (r.includes('legendary')) return 'rarity-legendary';
        if (r.includes('rare') && !r.includes('legendary')) return 'rarity-rare';
        if (r.includes('uncommon')) return 'rarity-uncommon';
        if (r.includes('special')) return 'rarity-special';
        return 'rarity-common';
      },

      getRarityColor(rarity) {
        const r = (rarity || '').toLowerCase();
        if (r.includes('legendary')) return 'var(--rarity-legendary)';
        if (r.includes('rare') && !r.includes('legendary')) return 'var(--rarity-rare)';
        if (r.includes('uncommon')) return 'var(--rarity-uncommon)';
        if (r.includes('special')) return 'var(--rarity-special)';
        return 'var(--rarity-common)';
      },

      // ========== BUYER CART ==========
      _cardKey(card) {
        return `${card.name}|${card.set}|${card.number}|${card.variantType}`;
      },

      addToBuyerCart(card) {
        const key = this._cardKey(card);
        const existing = this.buyerCart.find(i => this._cardKey(i.card) === key);
        if (existing) {
          if (existing.quantity < card.quantity) existing.quantity++;
        } else {
          this.buyerCart.push({ card, quantity: 1 });
        }
        this.updateCartUI();
      },

      removeBuyerCartItem(index) {
        this.buyerCart.splice(index, 1);
        this.updateCartUI();
        this.render(); // refresh add buttons
      },

      updateBuyerCartQty(index, delta) {
        const item = this.buyerCart[index];
        if (!item) return;
        const newQty = item.quantity + delta;
        if (newQty <= 0) {
          this.removeBuyerCartItem(index);
          return;
        }
        item.quantity = Math.min(newQty, item.card.quantity);
        this.updateCartUI();
      },

      clearBuyerCart() {
        this.buyerCart = [];
        this.updateCartUI();
        this.render();
      },

      updateCartUI() {
        const toggle = document.getElementById('buyer-cart-toggle');
        const badge = document.getElementById('buyer-cart-badge');
        const body = document.getElementById('buyer-cart-body');
        const totalEl = document.getElementById('buyer-cart-total');
        const copiedMsg = document.getElementById('cart-copied-msg');

        copiedMsg.style.display = 'none';

        const totalItems = this.buyerCart.reduce((s, i) => s + i.quantity, 0);
        badge.textContent = totalItems;
        toggle.hidden = this.buyerCart.length === 0;

        if (this.buyerCart.length === 0) {
          body.innerHTML = '<div class="cart-panel-empty">Click the + button on cards to add them here.</div>';
          totalEl.textContent = '$0.00';
          return;
        }

        body.innerHTML = '';
        let totalPrice = 0;

        this.buyerCart.forEach((item, i) => {
          const card = item.card;
          const lineTotal = card.marketPrice * item.quantity;
          totalPrice += lineTotal;
          const variantLabel = card.variantType && card.variantType !== 'Normal' ? card.variantType : '';

          const div = document.createElement('div');
          div.className = 'cart-item';
          div.innerHTML = `
            ${card.frontArt ? `<img class="cart-item-img" src="${this.esc(card.frontArt)}" alt="" onerror="this.style.display='none'">` : ''}
            <div class="cart-item-info">
              <div class="cart-item-name">${this.esc(card.name)}${card.subtitle ? ' â€” ' + this.esc(card.subtitle) : ''}</div>
              <div class="cart-item-meta">${this.esc(card.set)} #${card.number}${variantLabel ? ' | ' + this.esc(variantLabel) : ''}</div>
              <div class="cart-item-price">$${card.marketPrice.toFixed(2)}${item.quantity > 1 ? ' Ã— ' + item.quantity + ' = $' + lineTotal.toFixed(2) : ''}</div>
            </div>
            <div class="cart-item-qty">
              <button class="cart-qty-minus" data-idx="${i}">âˆ’</button>
              <span>${item.quantity}</span>
              <button class="cart-qty-plus" data-idx="${i}">+</button>
            </div>
            <button class="cart-item-remove" data-idx="${i}">âœ•</button>
          `;
          body.appendChild(div);
        });

        // Wire buttons
        body.querySelectorAll('.cart-qty-minus').forEach(btn =>
          btn.addEventListener('click', () => this.updateBuyerCartQty(parseInt(btn.dataset.idx), -1))
        );
        body.querySelectorAll('.cart-qty-plus').forEach(btn =>
          btn.addEventListener('click', () => this.updateBuyerCartQty(parseInt(btn.dataset.idx), 1))
        );
        body.querySelectorAll('.cart-item-remove').forEach(btn =>
          btn.addEventListener('click', () => this.removeBuyerCartItem(parseInt(btn.dataset.idx)))
        );

        totalEl.textContent = `$${totalPrice.toFixed(2)}`;
      },

      openCartPanel() {
        document.getElementById('buyer-cart-panel').classList.add('open');
        document.getElementById('buyer-cart-overlay').classList.add('open');
      },

      closeCartPanel() {
        document.getElementById('buyer-cart-panel').classList.remove('open');
        document.getElementById('buyer-cart-overlay').classList.remove('open');
      },

      async copyWishlist() {
        const buyerName = document.getElementById('buyer-name').value.trim() || 'A buyer';
        const lines = [];
        lines.push('--- SWU WISHLIST ---');
        lines.push(`From: ${buyerName}`);
        lines.push(`Date: ${new Date().toLocaleDateString()}`);
        lines.push('');
        lines.push('Name | Subtitle | Set | # | Variant | Qty | Price');
        lines.push('---|---|---|---|---|---|---');

        let total = 0;
        for (const item of this.buyerCart) {
          const c = item.card;
          const lineTotal = c.marketPrice * item.quantity;
          total += lineTotal;
          lines.push([
            c.name,
            c.subtitle || '',
            c.set,
            c.number,
            (c.variantType && c.variantType !== 'Normal') ? c.variantType : 'Normal',
            item.quantity,
            '$' + c.marketPrice.toFixed(2)
          ].join(' | '));
        }

        lines.push('');
        lines.push(`TOTAL: $${total.toFixed(2)} (${this.buyerCart.reduce((s,i) => s + i.quantity, 0)} cards)`);
        lines.push('--- END WISHLIST ---');

        const text = lines.join('\n');
        try {
          await navigator.clipboard.writeText(text);
          const msg = document.getElementById('cart-copied-msg');
          msg.style.display = 'block';
          setTimeout(() => { msg.style.display = 'none'; }, 4000);
        } catch (err) {
          // Fallback: show text in a prompt
          prompt('Copy this text and send it to the seller:', text);
        }
      },

      setupCartListeners() {
        document.getElementById('buyer-cart-toggle').addEventListener('click', () => this.openCartPanel());
        document.getElementById('buyer-cart-close').addEventListener('click', () => this.closeCartPanel());
        document.getElementById('buyer-cart-overlay').addEventListener('click', () => this.closeCartPanel());
        document.getElementById('btn-copy-wishlist').addEventListener('click', () => this.copyWishlist());
        document.getElementById('btn-clear-wishlist').addEventListener('click', () => {
          if (this.buyerCart.length === 0) return;
          this.clearBuyerCart();
          this.closeCartPanel();
        });
      },
    };

    document.addEventListener('DOMContentLoaded', () => PV.init());
  </script>
</body>
</html>
